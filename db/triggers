CREATE OR REPLACE FUNCTION insert_ord_trab_and_update_ot_equipos()
RETURNS TRIGGER AS $$
DECLARE
  new_ord_trab_id SMALLINT;
  nuevo_codigo TEXT;
BEGIN
  -- 1. Insertar en ord_trab (ajusta según tus columnas reales)
  INSERT INTO ord_trab DEFAULT VALUES
  RETURNING id INTO new_ord_trab_id;

  -- 2. Generar código con formato OM-06-2025-00000{id}
  nuevo_codigo := 'OM-06-2025-' || LPAD(new_ord_trab_id::text, 6, '0');

  -- 3. Actualizar la fila insertada en ot_equipos
  UPDATE ot_equipos
  SET
    id_ord_trab = new_ord_trab_id,
    n_ord_trabajo = nuevo_codigo
  WHERE id = NEW.id;

  RETURN NULL; -- AFTER trigger no necesita retornar NEW
END;
$$ LANGUAGE plpgsql;


CREATE TRIGGER trg_after_insert_ot_equipos
AFTER INSERT ON ot_equipos
FOR EACH ROW
EXECUTE FUNCTION insert_ord_trab_and_update_ot_equipos();
